import tempfile
from pathlib import Path

import pytest


@pytest.fixture
def mock_forcing_file() -> Path:
    """Alternative fixture that just returns the forcing file path"""
    forcing_csv_content = """Time,RAINRATE,T2D,Q2D,U2D,V2D,PSFC,SWDOWN,LWDOWN
    2012-06-01 00:00:00,0.00000000,290.82,0.00943, 0.681,-3.783, 99472.1,  9.43,349.05
    2012-06-01 01:00:00,0.00000000,289.42,0.00883, 0.708,-3.780, 99575.2,  0.00,348.57
    2012-06-01 02:00:00,0.00000000,288.02,0.00824, 0.726,-3.784, 99679.9,  0.00,348.04
    2012-06-01 03:00:00,0.00000000,286.63,0.00765, 0.753,-3.786, 99778.5,  0.00,288.50
    2012-06-01 04:00:00,0.00000000,285.41,0.00725, 0.695,-3.639, 99798.3,  0.00,287.96
    2012-06-01 05:00:00,0.00000000,284.19,0.00686, 0.627,-3.503, 99815.4,  0.00,287.37
    2012-06-01 06:00:00,0.00000000,282.97,0.00647, 0.558,-3.366, 99834.8,  0.00,276.47
    2012-06-01 07:00:00,0.00000000,282.12,0.00615, 0.786,-3.239, 99868.4,  0.00,275.88
    2012-06-01 08:00:00,0.00000000,281.27,0.00584, 1.012,-3.122, 99899.8,  0.00,275.32
    2012-06-01 09:00:00,0.00000000,280.43,0.00554, 1.235,-3.000, 99931.1,  0.00,271.13
    2012-06-01 10:00:00,0.00000000,282.55,0.00619, 0.533,-3.385,100016.4,126.43,273.17
    2012-06-01 11:00:00,0.00000000,284.66,0.00688,-0.164,-3.769,100103.7,264.76,275.21
    2012-06-01 12:00:00,0.00000000,286.78,0.00761,-0.865,-4.158,100187.0,415.81,283.86
    2012-06-01 13:00:00,0.00000000,287.87,0.00766,-1.098,-4.211,100176.8,582.22,284.86
    2012-06-01 14:00:00,0.00000000,288.96,0.00771,-1.337,-4.265,100165.6,725.73,285.85
    2012-06-01 15:00:00,0.00000000,290.05,0.00775,-1.562,-4.315,100152.6,736.78,323.72
    2012-06-01 16:00:00,0.00000000,290.69,0.00797,-1.384,-3.583,100124.5,777.34,324.24
    2012-06-01 17:00:00,0.00000000,291.33,0.00819,-1.204,-2.851,100102.7,765.80,324.79
    2012-06-01 18:00:00,0.00000000,291.97,0.00842,-1.019,-2.115,100076.5,726.64,352.97
    2012-06-01 19:00:00,0.00000000,292.39,0.00863,-1.208,-1.775,100037.9,657.28,353.15
    2012-06-01 20:00:00,0.00000000,292.81,0.00885,-1.403,-1.434, 99996.5,548.94,353.30
    2012-06-01 21:00:00,0.00000000,293.23,0.00906,-1.588,-1.090, 99955.0,408.04,365.80
    2012-06-01 22:00:00,0.00000000,292.05,0.00916,-1.765,-0.555, 99976.3,276.19,363.67
    2012-06-01 23:00:00,0.00000000,290.87,0.00924,-1.933,-0.024, 99999.4,148.15,361.58
    2012-06-02 00:00:00,0.00000000,289.69,0.00931,-2.110, 0.516,100015.0, 14.50,368.99
    2012-06-02 01:00:00,0.00000000,288.53,0.00875,-1.901, 1.046,100013.4,  0.00,366.73
    2012-06-02 02:00:00,0.00000000,287.36,0.00821,-1.693, 1.576,100008.9,  0.00,364.43
    2012-06-02 03:00:00,0.00000000,286.21,0.00770,-1.493, 2.105,100000.2,  0.00,357.29
    2012-06-02 04:00:00,0.00000000,285.59,0.00757,-1.604, 1.907,100051.4,  0.00,356.41
    2012-06-02 05:00:00,0.00000000,284.98,0.00744,-1.706, 1.707,100105.0,  0.00,355.51
    2012-06-02 06:00:00,0.00000000,284.37,0.00731,-1.817, 1.504,100156.0,  0.00,340.81
    2012-06-02 07:00:00,0.00000000,283.95,0.00718,-2.153, 1.253,100039.9,  0.00,340.79
    2012-06-02 08:00:00,0.00000000,283.53,0.00705,-2.490, 0.999, 99925.6,  0.00,340.74
    2012-06-02 09:00:00,0.00000000,283.11,0.00692,-2.831, 0.744, 99811.9,  0.00,335.06
    2012-06-02 10:00:00,0.00000000,284.82,0.00749,-3.293, 1.287, 99892.8, 97.82,338.34
    2012-06-02 11:00:00,0.00000000,286.52,0.00809,-3.754, 1.836, 99972.7,203.93,341.60
    2012-06-02 12:00:00,0.00000000,288.23,0.00873,-4.220, 2.379,100051.0,241.34,357.56
    2012-06-02 13:00:00,0.00000000,288.84,0.00918,-4.378, 2.751, 99973.2,337.72,358.75
    2012-06-02 14:00:00,0.00000000,289.44,0.00964,-4.529, 3.126, 99894.2,420.88,359.96
    2012-06-02 15:00:00,0.00000000,290.05,0.01011,-4.689, 3.503, 99817.1,374.38,375.68
    2012-06-02 16:00:00,0.00000000,289.88,0.01023,-5.542, 3.412, 99775.4,394.98,374.74
    2012-06-02 17:00:00,0.00004195,289.72,0.01034,-6.382, 3.327, 99737.8,389.05,373.78
    2012-06-02 18:00:00,0.00022062,289.55,0.01045,-7.237, 3.239, 99701.7,220.21,379.55
    2012-06-02 19:00:00,0.00033413,288.85,0.01008,-7.171, 3.274, 99610.1,199.29,378.02
    2012-06-02 20:00:00,0.00000000,288.15,0.00972,-7.109, 3.312, 99523.7,166.55,376.49
    2012-06-02 21:00:00,0.00019824,287.44,0.00937,-7.050, 3.334, 99434.6,137.15,370.12
    2012-06-02 22:00:00,0.00012572,287.00,0.00917,-6.796, 2.698, 99499.0, 92.97,369.70
    2012-06-02 23:00:00,0.00006814,286.55,0.00896,-6.544, 2.071, 99562.8, 50.16,369.23
    2012-06-03 00:00:00,0.00046570,286.11,0.00877,-6.290, 1.436, 99625.5,  5.84,364.48
    2012-06-03 01:00:00,0.00009975,285.57,0.00847,-6.987, 1.085, 99551.3,  0.00,364.16
    2012-06-03 02:00:00,0.00000056,285.03,0.00819,-7.675, 0.730, 99478.0,  0.00,363.79
    2012-06-03 03:00:00,0.00056555,284.49,0.00790,-8.376, 0.379, 99402.9,  0.00,361.27
    2012-06-03 04:00:00,0.00104942,284.22,0.00787,-7.656,-0.232, 99406.1,  0.00,361.05
    2012-06-03 05:00:00,0.00276809,283.95,0.00783,-6.942,-0.838, 99404.2,  0.00,360.76
    2012-06-03 06:00:00,0.00188491,283.68,0.00780,-6.224,-1.447, 99406.0,  0.00,355.86
    2012-06-03 07:00:00,0.00109557,283.46,0.00769,-5.862,-1.720, 99339.0,  0.00,355.73
    2012-06-03 08:00:00,0.00161947,283.25,0.00759,-5.499,-1.993, 99269.9,  0.00,355.59
    2012-06-03 09:00:00,0.00132801,283.03,0.00749,-5.143,-2.264, 99198.0,  0.00,355.94
    2012-06-03 10:00:00,0.00164322,283.17,0.00746,-5.159,-2.328, 99222.6, 31.75,355.85
    2012-06-03 11:00:00,0.00089006,283.30,0.00745,-5.184,-2.402, 99249.9, 65.92,355.79
    2012-06-03 12:00:00,0.00083439,283.44,0.00743,-5.200,-2.470, 99273.5, 79.35,355.59
    2012-06-03 13:00:00,0.00088553,283.86,0.00762,-5.360,-2.749, 99242.9,111.00,356.65
    2012-06-03 14:00:00,0.00044787,284.28,0.00782,-5.525,-3.019, 99210.3,138.25,357.73
    2012-06-03 15:00:00,0.00045817,284.71,0.00802,-5.677,-3.299, 99175.5,192.41,362.26
    2012-06-03 16:00:00,0.00071625,284.98,0.00820,-5.795,-3.426, 99138.9,203.08,362.60
    2012-06-03 17:00:00,0.00077639,285.25,0.00838,-5.906,-3.552, 99101.7,200.01,363.02
    2012-06-03 18:00:00,0.00096387,285.52,0.00856,-6.022,-3.684, 99060.6,220.02,362.02
    2012-06-03 19:00:00,0.00047413,285.48,0.00856,-5.393,-3.670, 99131.7,199.18,361.69
    2012-06-03 20:00:00,0.00067810,285.44,0.00856,-4.775,-3.651, 99207.2,166.55,361.38
    2012-06-03 21:00:00,0.00195890,285.40,0.00856,-4.154,-3.638, 99277.7,141.31,360.80
    2012-06-03 22:00:00,0.00206954,285.01,0.00844,-3.876,-3.795, 99242.0, 95.95,359.80
    2012-06-03 23:00:00,0.00095320,284.61,0.00832,-3.601,-3.957, 99204.0, 52.03,358.77
    2012-06-04 00:00:00,0.00082862,284.21,0.00819,-3.326,-4.118, 99167.0,  6.34,352.02
    2012-06-04 01:00:00,0.00077045,283.81,0.00800,-3.152,-4.290, 99129.7,  0.00,352.32
    2012-06-04 02:00:00,0.00095034,283.42,0.00781,-2.984,-4.465, 99085.2,  0.00,352.65
    2012-06-04 03:00:00,0.00137849,283.02,0.00761,-2.810,-4.633, 99049.1,  0.00,350.45
    2012-06-04 04:00:00,0.00112664,282.89,0.00754,-3.396,-4.994, 99050.4,  0.00,350.57
    2012-06-04 05:00:00,0.00150470,282.76,0.00747,-3.978,-5.351, 99048.7,  0.00,350.66
    2012-06-04 06:00:00,0.00152389,282.63,0.00740,-4.563,-5.710, 99051.6,  0.00,347.19
    2012-06-04 07:00:00,0.00058000,282.35,0.00726,-4.144,-5.593, 99003.4,  0.00,347.43
    2012-06-04 08:00:00,0.00056274,282.07,0.00711,-3.728,-5.475, 98955.6,  0.00,347.62
    2012-06-04 09:00:00,0.00033843,281.79,0.00697,-3.305,-5.356, 98908.3,  0.00,345.74
    2012-06-04 10:00:00,0.00093843,281.95,0.00699,-3.391,-5.467, 98952.6, 38.64,345.70
    2012-06-04 11:00:00,0.00039441,282.11,0.00701,-3.490,-5.589, 98991.4, 79.95,345.59
    2012-06-04 12:00:00,0.00043334,282.27,0.00703,-3.580,-5.703, 99037.6,116.42,350.64
    2012-06-04 13:00:00,0.00051540,282.78,0.00721,-3.580,-5.589, 99078.1,162.79,350.59
    2012-06-04 14:00:00,0.00060170,283.29,0.00739,-3.578,-5.480, 99117.5,202.78,350.53
    2012-06-04 15:00:00,0.00059787,283.79,0.00758,-3.579,-5.369, 99154.8,319.25,355.67
    2012-06-04 16:00:00,0.00028297,284.57,0.00773,-3.215,-5.280, 99206.3,336.90,355.64
    2012-06-04 17:00:00,0.00000000,285.35,0.00790,-2.854,-5.187, 99258.5,331.84,355.64
    2012-06-04 18:00:00,0.00000000,286.13,0.00806,-2.490,-5.105, 99310.3,530.86,343.73
    2012-06-04 19:00:00,0.00000000,286.46,0.00797,-2.883,-5.076, 99260.8,480.65,343.70
    2012-06-04 20:00:00,0.00015570,286.78,0.00788,-3.282,-5.046, 99213.8,402.27,343.62
    2012-06-04 21:00:00,0.00004562,287.11,0.00780,-3.676,-5.019, 99163.7,332.53,337.72
    2012-06-04 22:00:00,0.00000000,286.62,0.00770,-3.197,-4.450, 99266.8,226.27,337.81
    2012-06-04 23:00:00,0.00000000,286.13,0.00759,-2.714,-3.879, 99372.8,123.18,337.91
    2012-06-05 00:00:00,0.00000000,285.63,0.00749,-2.239,-3.313, 99479.0,  9.52,344.80
    2012-06-05 01:00:00,0.00000000,284.88,0.00737,-2.010,-3.513, 99412.0,  0.00,344.90
    2012-06-05 02:00:00,0.00000000,284.13,0.00724,-1.781,-3.719, 99347.3,  0.00,344.92
    2012-06-05 03:00:00,0.00000000,283.38,0.00712,-1.553,-3.926, 99284.3,  0.00,349.63
    2012-06-05 04:00:00,0.00000000,283.30,0.00712,-1.343,-4.204, 99315.0,  0.00,349.85
    2012-06-05 05:00:00,0.00000000,283.21,0.00711,-1.127,-4.477, 99345.5,  0.00,349.98
    2012-06-05 06:00:00,0.00000000,283.13,0.00712,-0.911,-4.760, 99378.8,  0.00,329.20
    2012-06-05 07:00:00,0.00000000,282.65,0.00692,-0.541,-4.058, 99343.6,  0.00,329.02
    2012-06-05 08:00:00,0.00000000,282.17,0.00673,-0.163,-3.358, 99308.6,  0.00,328.78
    2012-06-05 09:00:00,0.00004489,281.70,0.00654, 0.202,-2.662, 99273.3,  0.00,318.34
    2012-06-05 10:00:00,0.00005449,282.94,0.00698,-0.149,-3.171, 99369.2, 74.71,320.27
    2012-06-05 11:00:00,0.00014595,284.18,0.00743,-0.509,-3.669, 99464.9,154.11,322.19
    2012-06-05 12:00:00,0.00000000,285.41,0.00789,-0.867,-4.179, 99567.7, 92.21,361.65
    2012-06-05 13:00:00,0.00000000,285.94,0.00814,-1.005,-4.544, 99534.8,128.85,363.49
    2012-06-05 14:00:00,0.00000000,286.47,0.00839,-1.136,-4.903, 99502.5,160.51,365.31
    2012-06-05 15:00:00,0.00000000,286.99,0.00864,-1.275,-5.273, 99474.0,179.51,368.02
    2012-06-05 16:00:00,0.00000000,287.13,0.00885,-1.053,-5.210, 99534.2,189.44,368.45
    2012-06-05 17:00:00,0.00000000,287.27,0.00906,-0.826,-5.153, 99599.1,186.71,368.89
    2012-06-05 18:00:00,0.00001793,287.41,0.00927,-0.600,-5.097, 99664.9,251.30,358.59
    2012-06-05 19:00:00,0.00000000,287.61,0.00929,-0.526,-4.976, 99674.0,227.61,359.21
    2012-06-05 20:00:00,0.00016443,287.81,0.00931,-0.451,-4.856, 99680.1,190.45,359.82
    2012-06-05 21:00:00,0.00000003,288.02,0.00934,-0.382,-4.741, 99687.6,262.73,347.82
    2012-06-05 22:00:00,0.00000340,288.13,0.00938,-0.301,-4.262, 99707.6,179.09,349.11
    2012-06-05 23:00:00,0.00012690,288.23,0.00942,-0.221,-3.783, 99727.8, 97.89,350.41
    2012-06-06 00:00:00,0.00000000,288.34,0.00946,-0.143,-3.305, 99747.0,  8.01,362.45
    2012-06-06 01:00:00,0.00000000,286.75,0.00870,-0.036,-3.014, 99723.8,  0.00,356.84
    2012-06-06 02:00:00,0.00000000,285.17,0.00800, 0.072,-2.728, 99703.8,  0.00,351.29
    2012-06-06 03:00:00,0.00000000,283.59,0.00735, 0.186,-2.437, 99683.2,  0.00,340.78
    2012-06-06 04:00:00,0.00000000,283.06,0.00718, 0.272,-2.326, 99715.6,  0.00,339.36
    2012-06-06 05:00:00,0.00000000,282.53,0.00701, 0.366,-2.212, 99749.4,  0.00,337.88
    2012-06-06 06:00:00,0.00000000,282.00,0.00685, 0.459,-2.096, 99782.5,  0.00,331.24
    2012-06-06 07:00:00,0.00000000,281.75,0.00672, 0.504,-2.073, 99772.3,  0.00,330.77
    2012-06-06 08:00:00,0.00000000,281.50,0.00660, 0.547,-2.047, 99764.3,  0.00,330.30
    2012-06-06 09:00:00,0.00000000,281.25,0.00648, 0.597,-2.024, 99750.8,  0.00,336.40
    2012-06-06 10:00:00,0.00000000,282.42,0.00691, 0.389,-1.994, 99766.3, 57.51,338.02
    2012-06-06 11:00:00,0.00000000,283.60,0.00736, 0.183,-1.958, 99779.0,118.31,339.72
    2012-06-06 12:00:00,0.00000000,284.78,0.00782,-0.024,-1.927, 99795.9,205.36,354.20
    2012-06-06 13:00:00,0.00000000,285.65,0.00788, 0.135,-2.130, 99764.9,286.93,355.54
    2012-06-06 14:00:00,0.00000000,286.52,0.00795, 0.285,-2.341, 99733.2,357.30,356.91
    2012-06-06 15:00:00,0.00000000,287.39,0.00801, 0.447,-2.552, 99704.6,442.07,355.38
    2012-06-06 16:00:00,0.00000000,287.96,0.00814, 0.544,-2.804, 99737.1,466.56,356.33
    2012-06-06 17:00:00,0.00000000,288.52,0.00828, 0.644,-3.070, 99768.8,459.84,357.27
    2012-06-06 18:00:00,0.00000000,289.09,0.00842, 0.739,-3.320, 99800.2,539.21,347.84
    2012-06-06 19:00:00,0.00000000,289.52,0.00847, 0.428,-2.858, 99820.8,488.65,348.57
    2012-06-06 20:00:00,0.00000000,289.96,0.00852, 0.106,-2.390, 99841.8,409.35,349.33
    2012-06-06 21:00:00,0.00000000,290.40,0.00857,-0.217,-1.929, 99861.9,278.42,360.05
    2012-06-06 22:00:00,0.00000000,289.42,0.00849,-0.077,-1.584, 99864.6,190.10,358.60
    2012-06-06 23:00:00,0.00011774,288.44,0.00841, 0.065,-1.232, 99867.2,104.39,357.21
    2012-06-07 00:00:00,0.00000000,287.47,0.00833, 0.209,-0.887, 99866.1,  7.11,356.52
    2012-06-07 01:00:00,0.00000000,286.64,0.00800, 0.302,-0.848, 99895.0,  0.00,355.24
    2012-06-07 02:00:00,0.00000000,285.82,0.00768, 0.401,-0.815, 99919.7,  0.00,354.00
    2012-06-07 03:00:00,0.00000000,285.00,0.00737, 0.494,-0.775, 99950.5,  0.00,320.88
    2012-06-07 04:00:00,0.00000000,283.88,0.00702, 0.368,-1.053, 99920.8,  0.00,319.06
    2012-06-07 05:00:00,0.00000000,282.77,0.00668, 0.248,-1.334, 99895.1,  0.00,317.26
    2012-06-07 06:00:00,0.00000000,281.65,0.00635, 0.117,-1.623, 99865.6,  0.00,313.98
    2012-06-07 07:00:00,0.00000000,281.32,0.00622, 0.066,-1.705, 99836.8,  0.00,313.57
    2012-06-07 08:00:00,0.00000000,280.99,0.00610, 0.016,-1.796, 99806.4,  0.00,313.22
    2012-06-07 09:00:00,0.00000000,280.66,0.00597,-0.036,-1.881, 99776.2,  0.00,320.36
    2012-06-07 10:00:00,0.00000000,281.69,0.00640, 0.001,-1.749, 99831.1, 61.28,321.19
    2012-06-07 11:00:00,0.00000001,282.71,0.00684, 0.048,-1.627, 99884.5,125.74,322.05
    2012-06-07 12:00:00,0.00000000,283.74,0.00729, 0.090,-1.499, 99940.5,217.45,345.86
    2012-06-07 13:00:00,0.00000000,285.07,0.00768, 0.326,-1.486, 99908.4,303.71,347.39
    2012-06-07 14:00:00,0.00000000,286.41,0.00808, 0.551,-1.464, 99876.9,378.20,348.94
    2012-06-07 15:00:00,0.00000000,287.75,0.00849, 0.785,-1.452, 99845.5,650.87,337.87
    2012-06-07 16:00:00,0.00000000,288.74,0.00849, 0.485,-1.322, 99812.5,686.91,339.10
    2012-06-07 17:00:00,0.00000000,289.74,0.00848, 0.177,-1.194, 99776.8,677.09,340.33
    2012-06-07 18:00:00,0.00000000,290.74,0.00847,-0.121,-1.064, 99747.7,556.42,355.02
    2012-06-07 19:00:00,0.00000000,291.11,0.00864, 0.384,-0.936, 99739.2,504.34,355.71
    2012-06-07 20:00:00,0.00000000,291.49,0.00883, 0.895,-0.809, 99733.7,422.51,356.39
    2012-06-07 21:00:00,0.00000000,291.86,0.00901, 1.408,-0.692, 99727.7,281.24,368.73
    2012-06-07 22:00:00,0.00000000,290.92,0.00899, 1.144,-0.402, 99702.9,192.30,367.65
    2012-06-07 23:00:00,0.00000000,289.98,0.00896, 0.893,-0.119, 99680.7,106.06,366.53"""

    # Create temporary file
    temp_dir = tempfile.mkdtemp()
    forcing_file_path = Path(temp_dir) / "mock_forcing_cat-11223.csv"

    with open(forcing_file_path, "w") as f:
        f.write(forcing_csv_content)

    return forcing_file_path


@pytest.fixture
def mock_config(mock_forcing_file: Path) -> Path:
    mock_yaml_content = f"""
    site_prefix: cat-11223  # file prefix for the study site
    forcing file: {mock_forcing_file} # the forcing .csv file used in this test case
    n_steps: 10  # number of time steps
    dt: 3600.0   # timestep for snowmelt process [sec]
    Cp_snow: 2090.0 # heat capacity of snow [J/kg/K]
    Cp_ice: 2060.0   # heat capacity of ice [J/kg/K]
    rho_snow: 300.0  # density of snow [kg/m^3]
    rho_ice: 917.0  # density of ice [kg/m^3]
    h_active_layer: 0.125  # thickness of active ice layer [m]
    T0: -0.2  # reference temperature [deg C]
    h0_snow: 2.0  # depth of snow [m]
    h0_ice: 2.0  # depth of ice [m]
    h0_swe: 0.6  # depth of snow water equivalent (SWE) [m]
    h0_iwe: 1.834  # depth of ice water equivalent (IWE) [m]
    """
    # Create temporary file
    temp_dir = tempfile.mkdtemp()
    cfg_file_path = Path(temp_dir) / "mock_cfg_cat-11223.csv"

    with open(cfg_file_path, "w") as f:
        f.write(mock_yaml_content)

    return cfg_file_path
